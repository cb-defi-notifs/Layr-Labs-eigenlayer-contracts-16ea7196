# Contract specs

## Depositing assets with EigenLayer
Any Ethereum account with ETH, who wants to participate in EigenLayr whether as a self-operator or as a delegator, needs to first interact with [EigenLayerDeposit contract](./EigenLayrDeposit.sol) in order to subject their ETH to additional slashing conditions from EigenLayer. Based on how that account wants to stake ETH with EigenLayer, there are multiple options:
  - **Staking + DeFi + Restaking.** [`depositETHIntoLiquidStaking`](https://github.com/Layr-Labs/eignlayr-contracts/blob/849f755d926961c29584a2cb81a3f88335f51328/src/contracts/core/EigenLayrDeposit.sol#L62) enables re-staking of ETH with EigenLayer while requiring EigenLayer to stake the same ETH into beacon chain consensus via one of the liquid staking service. The staker needs to specify the liquid staking services `IERC20 liquidStakeToken` that it wants EigenLayer to use for staking its deposited ETH. `depositETHIntoLiquidStaking` also provides the option of specifying the DeFi investment strategy `IInvestmentStrategy strategy` that EigenLayer would use for investing the staking tokens that would be obtained from staking with the liquid staking services. 
  - **Existing staking with beacon chain + Restaking.**  As described below, EigenLayer provisions two methods for stakers to stake their ETH into securing consensus of beacon chain separately and then restake their already-staked ETH into EigenLayer. Both methods require providing a `proof` of having staked ETH into the consensus of beacon chain. To construct this `proof`, the snapshot of which `depositor` has staked what amount of ETH into beacon chain is captured using a merkle tree where the leaf node is given by `keccak256(abi.encodePacked(depositor, amount))`. The merkle root of this tree is then updated into EigenLayer every regular [`depositRootInterval`](https://github.com/Layr-Labs/eignlayr-contracts/blob/ad2cd3c4b2811730b15de3d6eacb6477b80ea933/src/contracts/middleware/DataLayr/DataLayrServiceManagerStorage.sol#L102). This is done using [`confirmDataStoreWithPOSt`](https://github.com/Layr-Labs/eignlayr-contracts/blob/bb9a773bde16bc4c7e81d2cd407531784fb75df6/src/contracts/middleware/DataLayr/DataLayrServiceManager.sol#L327). 
    - [`proveLegacyConsensusLayerDeposit`](https://github.com/Layr-Labs/eignlayr-contracts/blob/f0724479452c9fbb7bb72cd20a86d4f0abe67050/src/contracts/core/EigenLayrDeposit.sol#L137) enables already-staked ETH stakers to restake their staked ETH with EigenLayer by submitting a Merkle proof of being a staker in the beacon chain (as a `calldata`). This is necessary as withdrawals and transfer of withdrawal certificate are not enabled yet in Ethereum.
    - [`proveLegacyConsensusLayerDepositBySignature`](https://github.com/Layr-Labs/eignlayr-contracts/blob/f0724479452c9fbb7bb72cd20a86d4f0abe67050/src/contracts/core/EigenLayrDeposit.sol#L91) enables any third-party (`msg.sender`) to submit a Merkle proof of staking into beacon chain on behalf of an already-staked ETH staker `depositor`. This requires `msg.sender` to get signature for a specific message from the `depositor` which is then [verified](https://github.com/Layr-Labs/eignlayr-contracts/blob/92610099e227eca11ea94c025ba8b5eaa9bf6c50/src/contracts/core/EigenLayrDeposit.sol#L157).  
  - **Staking + Restaking.**  [`depositEthIntoConsensusLayer`](https://github.com/Layr-Labs/eignlayr-contracts/blob/7a8a4bfe90e1c0129dc97d95de28056db1b02dbe/src/contracts/core/EigenLayrDeposit.sol#L222) re-staking of ETH with EigenLayer while requiring EigenLayer to stake the same ETH into Ethereum consensus layer via [ETH2 deposit contract](https://etherscan.io/address/0x00000000219ab540356cbb839cbe05303d7705fa). Note that this deposit into ETH2 deposit contract is done using withdrawal credentials of EigenLayer.



For any restaking of ETH that requires staking into beacon chain via liquid staking services, DeFi investment startegy for the staking tokens needs to be specified. With that, the staker agrees to [approve EigenLayer](https://github.com/Layr-Labs/eignlayr-contracts/blob/751c44aee733e0bf720bb47cf0181c545992eb83/src/contracts/core/EigenLayrDeposit.sol#L80) to manage the DeFi investment startegy of these staking tokens. Towards that end, `InvestmentManager.depositIntoStrategy` is [called](https://github.com/Layr-Labs/eignlayr-contracts/blob/751c44aee733e0bf720bb47cf0181c545992eb83/src/contracts/core/EigenLayrDeposit.sol#L82).


Any restaking of ETH that doesn't require any liquid staking is also considered as an investment. In order to record any of this restaked ETH as a share in the investment, there are two investment strategies -- `consensusLayerEthStrat` and `proofOfStakingEthStrat`. Both are designed to be [`HollowInvestmentStrategy`](../investment/HollowInvestmentStrategy.sol). `consensusLayerEthStrat` is for those ETH deposits that are supposed to be directly staked into securing consensus of beacon chain and then restaking that ETH into EigenLayer. In order to record any restaking of ETH with EigenLayer under this mechanism `InvestmentManager.depositConsenusLayerEth` is [called](https://github.com/Layr-Labs/eignlayr-contracts/blob/024833bb542437df97394db530c548ef8a8d1612/src/contracts/core/EigenLayrDeposit.sol#L242). On the other hand, `proofOfStakingEthStrat` is for those ETH deposits that have been staked into securing the consensus of beacon chain separately and then is being restaked into EigenLayer.  In order to record any restaking of ETH with EigenLayer under this mechanism `InvestmentManager.depositProofOfStakingEth` is [called](https://github.com/Layr-Labs/eignlayr-contracts/blob/024833bb542437df97394db530c548ef8a8d1612/src/contracts/core/EigenLayrDeposit.sol#L216). 





## Managing Investment Strategies
The primary contract for managing investment strategies is [InvestmentManager](../investment/InvestmentManager.sol). 

### Depositing into strategies
[`depositIntoStrategy`](https://github.com/Layr-Labs/eignlayr-contracts/blob/230dca4458576db0da944ac7beb2f44f2da19a8e/src/contracts/investment/InvestmentManager.sol#L114) and [`depositIntoStrategies`](https://github.com/Layr-Labs/eignlayr-contracts/blob/230dca4458576db0da944ac7beb2f44f2da19a8e/src/contracts/investment/InvestmentManager.sol#L151) are the two functions that are used for depositing any new token from any staker into investment startegy(s). Calling these functions require specifying the investment strategy(s) and the amount(s) of the token(s) being invested in each of the respective strategy(s). These two functions [transfer](https://github.com/Layr-Labs/eignlayr-contracts/blob/b14358360dabb30538b1de72e944fd6aa37f21bc/src/contracts/investment/InvestmentManager.sol#L200) the assets to the specified investment strategies and in return [obtain](https://github.com/Layr-Labs/eignlayr-contracts/blob/b14358360dabb30538b1de72e944fd6aa37f21bc/src/contracts/investment/InvestmentManager.sol#L209) the equivalent amount of shares of the delegator in that strategy. The updated shares of the staker into the specified strategy is [recorded](https://github.com/Layr-Labs/eignlayr-contracts/blob/b14358360dabb30538b1de72e944fd6aa37f21bc/src/contracts/investment/InvestmentManager.sol#L212) in `investorStratShares`. Additionally, if the staker is a delegator (that is not a self-operator), then the shares delegated with the delegator's operator is [incremented](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L121). Furthermore, the operator's delegationTerms contract is [called](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L134) to update weights of individual delegator.

### Withdrawing from strategies
#### Part 1
[`withdrawFromStrategy`](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L220) and [`withdrawFromStrategies`](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L263) are the two functions that are used by any staker for withdrawing from all its investment startegy(s). Note that these functions can be called only if the delegator has already notified that it intends to undelegate from EigenLayer. This is checked using the modifier [onlyNotDelegated](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L225). As part of withdrawal, the shares that depositor holds in the strategy(s) are [decreased](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L345) by `shareAmount`. If `shareAmount` represents all of the depositor's shares in said strategy, then the strategy is also [removed](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L354) from `investorStrats[depositor]`. After that, the tokens are [transferred back](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L324) to the delegator. Furthermore, the shares delegated with the delegator's operator is [decremented](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L236). 


#### Part 2
In order to be able to withdraw only a specific amount of assets from its strategies without undelegating, the delegator needs to call [`queueWithdrawal`](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L404). 

