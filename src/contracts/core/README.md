# Contract specs

## Depositing assets with EigenLayer
Any Ethereum account with ETH (or other tokens), who wants to participate in EigenLayr whether as a staker or as an operator, needs to first interact with the [InvestmentManager](.src/contracts/investment/InvestmentManager.sol) contract in order to subject their assets to additional slashing conditions from EigenLayer. Based on how that account wants to stake with EigenLayer, there are multiple paths:

## Managing Investment Strategies
The primary contract for managing investment strategies is [InvestmentManager](.src/contracts/investment/InvestmentManager.sol). 

### Depositing into strategies
[`depositIntoStrategy`](https://github.com/Layr-Labs/eignlayr-contracts/blob/230dca4458576db0da944ac7beb2f44f2da19a8e/src/contracts/investment/InvestmentManager.sol#L114) is the primary function that is used for depositing any new token from any staker into investment startegy(s). Calling this function requires specifying the investment strategy and the amount of the token being invested in the strategy. This function [transfers](https://github.com/Layr-Labs/eignlayr-contracts/blob/b14358360dabb30538b1de72e944fd6aa37f21bc/src/contracts/investment/InvestmentManager.sol#L200) the assets to the specified investment strategies and in return [obtains](https://github.com/Layr-Labs/eignlayr-contracts/blob/b14358360dabb30538b1de72e944fd6aa37f21bc/src/contracts/investment/InvestmentManager.sol#L209) the equivalent amount of shares in that strategy. The updated shares of the staker into the specified strategy is [recorded](https://github.com/Layr-Labs/eignlayr-contracts/blob/b14358360dabb30538b1de72e944fd6aa37f21bc/src/contracts/investment/InvestmentManager.sol#L212) in `investorStratShares`. Additionally, if the staker is a actively delegated, then the shares delegated with the delegator's operator are [incremented](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L121). Furthermore, the operator's delegationTerms contract is [called](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L134) to potentially update weights of the individual delegator.

### Withdrawing from strategies
#### Part 1
[`withdrawFromStrategy`](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L220) is the function that is used by any staker to withdraw from all an investment startegy. Note that these functions can be called only if the delegator has already notified that it intends to undelegate from EigenLayer. This is checked using the modifier [onlyNotDelegated](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L225). As part of withdrawal, the shares that depositor holds in the strategy(s) are [decreased](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L345) by `shareAmount`. If `shareAmount` represents all of the depositor's shares in said strategy, then the strategy is also [removed](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L354) from `investorStrats[depositor]`. After that, the tokens are [transferred back](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L324) to the delegator. Furthermore, the shares delegated with the delegator's operator is [decremented](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L236). 


#### Part 2
In order to be able to withdraw only a specific amount of assets from its strategies without undelegating first, the delegator needs to call [`queueWithdrawal`](https://github.com/Layr-Labs/eignlayr-contracts/blob/ee6588470dfe804bb0b69c232ae93a378905db21/src/contracts/investment/InvestmentManager.sol#L404). This function decreases the shares that depositor holds in strategies by calling `_removeShares` and then queues the corresponding withdrawal request in `queuedWithdrawals`. In order to ensure that the delegator's stake is still subject to slashing due to any ongoing task for which it is obligated to provide service, `fraudproofQueuedWithdrawal` can be called by anyone else to extend the `latestFraudproofTimestamp` which in turn extends the `unlockTime` if there is still at least one service where the `depositer` is obligated to continue provide service. 



### Delegation with EigenLayer
`EigenLayrDelegation` is the contract for delegation in EigenLayer. The main functionalities of this contract are:
   - for enabling any staker to register as an operator and specify the DelegationTerms it is providing to stakers.  This is done by calling `registerAsOperator`. 
   - for a depositor to delegate its stake to the operator of its agreed upon DelegationTerms contract. This is done using `delegateTo` or `delegateToBySignature`. The later function allows the delegation transaction to be performed by the third party, using a staker's signature.
   - for a delegator to undelegate its assets from EigenLayer. That requires the delegator to call `commitUndelegation` in order to notify the system that the delegator wants to stop  participating in the functioning of EigenLayer. Then, `finalizeUndelegation` must be called by a delegator to notify that its stake is no longer active on any queries, which in turn launches the challenge period. Next, anyone can call `contestUndelegationCommit` to challenge whether a delegator has finalized its undelegation after satisfying its obligations in EigenLayr or not.